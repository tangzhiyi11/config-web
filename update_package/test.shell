#base
cd env;./env;cd -
chkconfig postfix off
chkconfig nginx off
\cp -f external/nginx.conf /etc/nginx/
\cp -f external/server.crt /etc/nginx/
\cp -f external/tianyan.key /etc/nginx/
\cp -f external/nginx_sensor.conf /etc/nginx/conf.d/

\cp -f external/redis_7001.aof /etc/
\cp -f external/supervisord.conf /etc/
\cp -f external/supervise /usr/local/bin/
\cp -f external/libthrift.so.0 /usr/lib64/
\cp -f external/libpcre.so.1 /usr/lib64/
\cp -f external/libxml2.so.2 /usr/lib64/
\cp -f external/libzmq.so.3.0.0 /usr/lib64/
\cp -f external/igb.ko /lib/modules/`uname -r`/drivers/net/igb/
\cp -f external/igb.ko /lib/modules/`uname -r`/kernel/drivers/net/igb/
\cp -f external/iptables /etc/sysconfig/iptables
\cp -f external/rc.local /etc/rc.d/rc.local
\cp -f external/crontab /etc/crontab
patch -fNp0 < external/sys.patch

#log
mkdir -p /var/skyeye/
mkdir -p /data/pcaps/
mkdir -p /opt/update_temp/

#lic
\cp -rf external/pf_ring/ /etc/

#app
UPDATE_TMP="/tmp/update/"
mkdir $UPDATE_TMP
cp -af /opt/work/configs $UPDATE_TMP
mv /opt/work/web/sensor/data/conf.ini $UPDATE_TMP
rm -f $UPDATE_TMP/configs/share_memory.cfg
rm -f $UPDATE_TMP/configs/version
rm -f $UPDATE_TMP/configs/web_rule.xml
rm -f $UPDATE_TMP/configs/webmail.cfg
tar zxvf app.tgz -C /opt/work/
cp -af $UPDATE_TMP/configs/* /opt/work/configs
mv -f $UPDATE_TMP/conf.ini /opt/work/web/sensor/data/conf.ini
rm -rf $UPDATE_TMP
sed -i 's/#UseDNS yes/UseDNS no/g' /etc/ssh/sshd_config
sed -i 's/GSSAPIAuthentication yes/GSSAPIAuthentication no/g' /etc/ssh/sshd_config
sed -i 's/SINGLE=\/sbin\/sushell/SINGLE=\/sbin\/sulogin/' /etc/sysconfig/init
sed -i 's/ONBOOT="no"/ONBOOT="yes"/g' /etc/sysconfig/network-scripts/ifcfg-eth0
sed -i 's/ONBOOT="no"/ONBOOT="yes"/g' /etc/sysconfig/network-scripts/ifcfg-eth1
sed -i 's/ONBOOT="no"/ONBOOT="yes"/g' /etc/sysconfig/network-scripts/ifcfg-eth2
sed -i 's/ONBOOT="no"/ONBOOT="yes"/g' /etc/sysconfig/network-scripts/ifcfg-eth3
sed -i 's/ONBOOT="no"/ONBOOT="yes"/g' /etc/sysconfig/network-scripts/ifcfg-eth4
sed -i 's/ONBOOT="no"/ONBOOT="yes"/g' /etc/sysconfig/network-scripts/ifcfg-eth5
sed -i 's/OpenSSH_5.3/OpenSSH_x.x/g' /usr/sbin/sshd
ls /etc/product_serial || cat /sys/class/dmi/id/product_serial > /etc/product_serial;chmod 444 /etc/product_serial
ipcs -m | awk '$2 ~/[0-9]+/ {print $2}' | while read s; do sudo ipcrm -m $s; done
service sshd restart
userdel -f admin
userdel -f shpass

core=`grep processor /proc/cpuinfo |wc -l`
mem=`grep MemTotal /proc/meminfo |awk '{print $2}'`
if [ $core -gt 12 -a $mem -gt 33554432 ];then
	echo "high-end equipment"
else
	echo "low-end equipment"
	sed -i 's/-c 1 -n 6/-c 1 -n 3/' /opt/work/supervisor/S20pflow
	sed -i 's/numprocs=6/numprocs=3/' /opt/work/supervisor/S20pflow
	sed -i 's/numprocs=8/numprocs=5/' /opt/work/supervisor/S50other
	sed -i 's/shm_num=9/shm_num=6/g' /opt/work/configs/share_memory.cfg
	sed -i 's/thread_num = 18/thread_num = 12/' /opt/work/configs/file_prc.cfg
	sed -i 's/detect_thread_num = 9/detect_thread_num = 6/' /opt/work/configs/web_detect.cfg
	sed -i 's/irq_affinity=23/irq_affinity=11/' /opt/work/pflow/scripts/config
fi

#web
WEBHOME="/opt/work/web/sensor"
crontab -r -u webapi
#userdel -rf webapi
adduser webapi
#su webapi	TODO
mkdir -p "$WEBHOME"
mkdir -p "$WEBHOME/data/"
mkdir -p "$WEBHOME/update/"
mkdir -p "$WEBHOME/logs/"
mkdir -p "$WEBHOME/www/"
tar zxvf xenadmin-1.0.dev-r100.tar.gz -C /opt/work/web/sensor/env/lib/python2.7/site-packages/xenadmin-1.0.dev_r100-py2.7.egg
ln -s /opt/work/web/sensor/env/lib/python2.7/site-packages/xenadmin-1.0.dev_r100-py2.7.egg/xenadmin/ /opt/work/web/sensor/.source
\cp -f external/sudoers /etc/sudoers
chmod 440 /etc/sudoers
\cp -f external/priv.pem "$WEBHOME/data/"
\cp -f external/pub.pem "$WEBHOME/data/"
\cp -f external/cert.pem "$WEBHOME/data/"
\cp -f external/custom.ini "$WEBHOME/data/"
\cp -f external/webapi.sh /etc/profile.d/
rm -f /etc/profile.d/xenwebsensor.sh		#TMP
\cp -f external/python.fcgi "$WEBHOME/www/"
chown -R webapi:webapi $WEBHOME
chown -R webapi:webapi /opt/update_temp/
chown -R webapi:webapi /data/pcaps/
rm -rf /tmp/*.egg-tmp

python external/do_update_conf.py
sh external/fix_file_num.sh

#restart
#Now Without Reboot ^_^
#service network restart >/dev/null
service iptables restart >/dev/null
/opt/work/pflow/scripts/init_plsh.sh >/dev/null
/opt/work/pflow/scripts/start_driver.sh >/dev/null
pkill -f /usr/bin/supervisord
supervisord -c /etc/supervisord.conf >/dev/null
#supervisorctl reload 
#backup

#test
\cp test /tangzhiyi/data
rm -fr work/wet
`ff`

